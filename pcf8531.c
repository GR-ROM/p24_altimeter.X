
#include "i2c.h"
#include <xc.h>
#include <stdint.h>
#include "pcf8531.h"


#define FCY 48000000
#include <libpic30.h>

#define LCD_RESET_PIN 11
#define LCD_ADDR 0b01110000
#define LCD_PORT PORTD
#define LCD_TRIS TRISD

#define SET_LCD_RESET (LCD_PORT|=1<<LCD_RESET_PIN);
#define CLR_LCD_RESET (LCD_PORT&=~(1<<LCD_RESET_PIN));

#define CON1 (0b10000000)
#define CON2 (0b01000000) 

void init_uc1601c() {
    LCD_TRIS&=~(1<<LCD_RESET_PIN);
    i2c_init();
    CLR_LCD_RESET
    __delay_ms(20);
    SET_LCD_RESET
    __delay_ms(20);
    i2c_write_c(UC1601s_ADDR_C, 0b11100010);
    __delay_ms(16);
    i2c_start(); // 0x70 ????? ??????????, 0-???????, 0-??????
    i2c_send(UC1601s_ADDR_C);
    i2c_send(0x25); // set temperatrue compensation
    i2c_send(0x2e); //set internal pump
    i2c_send(0x81); // set pm
    i2c_send(120);
    i2c_send(0x89); //set ram adress control
    i2c_send(0xeb); // set bias 1/9
    i2c_send(0xc6); //set lcd mapping control   0xc6

    i2c_send(0xf2);
    i2c_send(0);
    i2c_send(0xf3);
    i2c_send(63);
    i2c_send(0x85);

    i2c_send(0xaf); // ???????? ???????
    i2c_stop();
}

void clear_lcd(char tip) {
    int a;
    i2c_start(); // 0x70 ????? ??????????, ???????, ??????
    i2c_send(UC1601s_ADDR_C);
    i2c_send(0b10110000); // ???????? 0
    i2c_send(0b00000000); // ??????? 0
    i2c_send(0b00010000); //
    i2c_stop();

    i2c_start(); // 0x70 ????? ??????????, ??????, ??????
    i2c_send(UC1601s_ADDR_D);
    if (tip == 0) for (a = 0; a < 1056; a++)i2c_send(0b00000000);
    else if (tip == 1) for (a = 0; a < 1056; a++)i2c_send(0b11111111);
    else for (a = 0; a < 528; a++) {
            i2c_send(0xAA);
            i2c_send(0x55);
        }
    i2c_stop();
}

void point_lcd(int tip, int X, int Y) {
#define bitset(var,bitno) ((var) |= 1<<(bitno)); 	// ??????????
#define bitclr(var,bitno) ((var) &= ~(1<<(bitno)));	// ????????
    int fon, Ya;
    int a;
    // ??????????? ????????? ?????????? ????? ? ????????? ???????
    Ya = Y % 8; // ????????? ????? ? ?????.
    if ((Y / 8) == 0)Y = (Y / 8); //
    else Y = (Y / 8); //

    // ????????? ???????
    i2c_start(); // 0x70 ????? ??????????, ???????, ??????
    i2c_send(UC1601s_ADDR_C);
    i2c_send(0b10110000); // ???????? 0
    i2c_send(0b00000000); // ??????? 0
    i2c_send(0b00010000); //
    i2c_stop();
    // ?????? ????????????????? ?????
    i2c_start(); // 0x70 ????? ??????????, ??????, ??????
    i2c_send(UC1601s_ADDR_D);
    for (a = 0; a != 1000; a++) {
        i2c_send(0xAA);
        i2c_send(0x55);
        __delay_ms(20);
    }
    i2c_stop();

}